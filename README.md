### 项目5：基于STM32的智能安防系统（环境检测）

时间：2021-03-13 至2021-03-17

#### 项目描述

本次项目是基于STM32F407平台，搭载实时操作系统UCOSIII，使用STM32库函数和c语言进行开发，设计一个智能安防环境检测系统，主要通过蓝牙模块、矩阵键盘、SR04超声波模块、实时时钟、DHT11温湿度模块、OLED显示模块等，实现了对各项环境数据的读取，并通过LED、蜂鸣器和OLED显示屏进行响应和处理。

#### 项目需求

1、**手机蓝牙操作**

- 输入6位密码登录系统

   -密码正确：嘀一声示意；

   -密码失败：蜂鸣器长鸣一会；

- 查询开发板累计运行的时间

- 查询当前温湿度状态

- 修改登录密码

- 可设置超声波模块报警距离

- 蓝牙连接状态（有个状态引脚可以识别到蓝牙模块的连接/断开状态）

  -连接：点亮LED1

  -断开：熄灭LED1

**2. 矩阵键盘**

- 输入常规6位密码登录系统

   -密码正确：嘀一声示意；

   -密码失败：蜂鸣器长鸣一会；

- 登录系统后

   -按下“A”，可查询当前温度

   -按下“B”，可查询当前湿度

   -按下“C”，可查询当前超声波测距

   -按下“D”，可查询开发板累计运行时间

   -按下“*”，可复位系统

   -按下“#”，可修改登录密码（选做）

- 支持输入10位的虚位密码登录系统（选做）

   -密码正确：嘀一声示意；

   -密码失败：蜂鸣器，长鸣一会；

**3. 超声波模块**

- 探测距离小于预设的报警距离，LED4急速闪烁

**4. 串口1/蓝牙调试助手/OLED实时显示操作信息。**

#### 环境搭建

开发平台/工具：Keil5

运行平台：ARM(stm32f407)

下载工具：J-Link

#### 涉及知识

GPIO、定时器、串口、RTC、FLASH、I2C、单总线通信、AT指令等

#### 具体描述

1、 通过蓝牙和矩阵键盘进行虚位密码登录系统，蓝牙连接LED1点亮

2、 登录系统后，可通过蓝牙命令和矩阵键盘操作单片机做出响应，可修改系统登录密码，系统时间，设置闹钟，预警距离，可检测环境温湿度，查询系统运行时间

3、 利用矩阵键盘实现系统软件复位，以及环境温湿度检测，预警距离检测，系统运行时间

4、 通过OLED显示时钟，响应闹钟和预警距离

5、 系统密码保存在内部FLASH中，通过擦除读写操作数据

6、 使用实时操作系统，蓝牙、矩阵键盘、LED和蜂鸣器使用消息队列发送和接收数据，LED和蜂鸣器通过信号量控制访问资源，实时时钟rtc和闹钟使用事件标志组，OLED显示使用互斥锁，防止其他任务抢占资源

####  待完善

1、 矩阵按键，温湿度不响应

2、 闹钟在修改时间后，不会再次响应

3、 蓝牙温湿度命令和矩阵按键键值响应冲突

#### 项目总结

1、 使用实时操作系统运行任务，代码层次确实比较清晰，但任务管理起来相对复杂，

2、 时间片抢占问题仍有，温湿度任务被抢占

3、 时间设置时，时间结构体是共用的，会造成访问冲突

4、 Stm32开发不仅是代码的编写，对硬件连接、时序图和原理图都要求较高

5、后面多研究一下模块化编程和实时任务管理